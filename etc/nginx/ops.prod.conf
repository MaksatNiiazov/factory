upstream django_ops_gunicorn {
    server unix:/run/ops/gunicorn.sock;
}

upstream ops_channels_backend {
    server unix:/run/ops/daphne.sock;
}

server {
    listen 80;
    server_name wicad-ops.witz.local;

    client_max_body_size 64M;

    access_log /var/log/nginx/ops-access.log;
    error_log /var/log/nginx/ops-error.log;

    location ^~ /joomla.xml         {return 444;}
    location ^~ /administrator/     {return 444;}
    location ^~ /services/MyICOffice/ {return 444;}
    location ^~ /a2billing/         {return 444;}
    location ^~ /admin/i18n/readme.txt {return 444;}
    location ~ \/\.git\/            {return 444;}
    location ~ \.php$               {return 444;}
    location ^~ /blog/              {return 444;}
    location ~ \.env$               {return 444;}
    location ~ \.env\/$             {return 444;}
    location ^~ /phpinfo            {return 444;}
    location ^~ /_ignition/         {return 444;}
    location ^~ /api/graphql        {return 444;}
	location ^~ /api/v4/ci          {return 444;}
	location ~ \.rsp$               {return 444;}
	location ^~ /_snapshot/         {return 444;}
	location ^~ /admin-console/     {return 444;}
	location ^~ /_users/org.couchdb.user {return 444;}
	location ^~ /api/proxy/tcp      {return 444;}
	location ^~ /_config            {return 444;}

    location = /favicon.ico { access_log off; log_not_found off; }

    location ^~ /static/ {
        root /var/www/ops;
        add_header Access-Control-Allow-Origin "http://92.118.114.27 http://92.118.114.27:8118 http://localhost:3000 http://192.168.3.143 http://192.168.3.143:8111 http://wicad-ops.witz.local:8111" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
        try_files $uri =404;

        if ($request_method = OPTIONS) {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location ^~ /media/ {
        root /var/www/ops;
        add_header Access-Control-Allow-Origin "http://92.118.114.27 http://92.118.114.27:8118 http://localhost:3000 http://192.168.3.143 http://192.168.3.143:8111 http://wicad-ops.witz.local:8111" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
        try_files $uri =404;

        if ($request_method = OPTIONS) {
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location = /api/ws/ {
        proxy_pass          http://ops_channels_backend;

        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";

        proxy_redirect     off;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;
    }

    location ~^/(admin|api|ops|_nested_admin|ru|en|i18n|kernel) {
        proxy_pass          http://django_ops_gunicorn;
        proxy_set_header    Host $host;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header    X-SSL-Client-Serial $ssl_client_serial;
        proxy_set_header    X-SSL-Client-S-Dn $ssl_client_s_dn;
        proxy_set_header    REMOTE_ADDR $remote_addr;
        proxy_read_timeout  90;
    }

    location / {
        expires -1;
        add_header Pragma "no-cache";
        add_header Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0";

        root /home/ops/witzenmann-ops-front/dist;
        try_files $uri $uri/ /index.html =404;
    }
}

server {
    listen 8111;
    server_name wicad-ops.witz.local;

    client_max_body_size 64M;

    location = /favicon.ico { access_log off; log_not_found off; }

    location / {
        expires -1;
        add_header Pragma "no-cache";
        add_header Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0";

        root /home/ops/witzenmann-ops-admin/build;
        try_files $uri $uri/ /index.html =404;
    }
}
